{% extends 'layout.html' %}
{% load static %}


{% block content %}

  <!-- Content Header (Page header) -->
  {% if err %}
    <div class="alert alert-danger alert-dismissible">
      <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
      <h4><i class="icon fa fa-ban"></i> {{ err.title }}</h4>
      {{ err.message }}
    </div>
  {% endif %}
  {% if success %}
    <div class="alert alert-success alert-dismissible">
      <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
      <h4><i class="icon fa fa-ban"></i> {{ success.title }}</h4>
      {{ success.message }}
    </div>
  {% endif %}

  <div class="content-header">
    <div class="container-fluid">
      <!-- interactive chart -->
            <div class="card card-primary card-outline">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="far fa-chart-bar"></i>
                   Real-time Stock price
                </h3>

                <div class="card-tools">
                  Real time
                  <div class="btn-group" id="realtime" data-toggle="btn-toggle">
                    <button type="button" class="btn btn-default btn-sm active" data-toggle="on">On</button>
                    <button type="button" class="btn btn-default btn-sm" data-toggle="off">Off</button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div id="interactive" style="height: 300px;"></div>
              </div>
              <!-- /.card-body-->
            </div>
    </div>
  </div>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-12">

          <!-- /.card -->
        </div>
      </div>
    </div>
  </section>


{% endblock %}


{% block script %}
  <!-- jQuery 3 -->
  <script src="{% static "plugins/jquery/jquery.min.js" %}"></script>
  <!-- Bootstrap 3.3.7 -->
  <script src="{% static "plugins/bootstrap/js/bootstrap.bundle.min.js" %}"></script>
  <!-- DataTables -->
  <script src="{% static "plugins/datatables/jquery.dataTables.min.js" %}"></script>
  <script src="{% static "plugins/datatables-bs4/js/dataTables.bootstrap4.min.js" %}"></script>
  <!-- FastClick -->
  <script src="{% static "plugins/fastclick/fastclick.js" %}"></script>
  <!-- AdminLTE App -->
  <script src="{% static "dist/js/adminlte.min.js" %}"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="{% static "dist/js/demo.js" %}"></script>
  <!-- page script -->
  <script>
      $(function () {
          $('#example1').DataTable({
              "scrollX": false,
              "autoWidth": true
          });
          $('#example2').DataTable({
              'paging': true,
              'lengthChange': false,
              'searching': false,
              'ordering': true,
              'info': true,
              'autoWidth': false
          })
      });

      function switch_public(id) {
          var token = prompt("请输入Token:");
          $.ajax({
              type: 'POST',
              url: '',
              async: false,
              data: {"optype": "switch_public", "token": token, "id": id, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
              success: function (data) {
                  if (data.response != "success") {
                      if (data.response == "error") {
                          alert(data.msg);
                      } else {
                          alert(data.response);
                          console.log(data);
                      }
                  } else {
                      alert("操作成功！");
                      location.reload();
                  }
              },
          });
      }

      function del_bot(id) {
          var token = prompt("请输入Token:");
          $.ajax({
              type: 'POST',
              url: '',
              async: false,
              data: {"optype": "del_bot", "token": token, "id": id, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
              success: function (data) {
                  if (data.response != "success") {
                      if (data.response == "error") {
                          alert(data.msg);
                      } else {
                          alert(data.response);
                          console.log(data);
                      }
                  } else {
                      alert("操作成功！");
                      location.reload();
                  }
              },
          });
      }

      function download_conf(id) {
          var token = prompt("请输入Token:");
          var request = new XMLHttpRequest();
          request.open('POST', '', true);
          request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          request.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
          request.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
          request.responseType = 'blob';
          request.onload = function(e) {
              if (this.status === 200) {
                var blob = this.response;
                var fileName = "config.json";
                console.log(blob);
                if(window.navigator.msSaveOrOpenBlob) {
                  window.navigator.msSaveBlob(blob, fileName);
                } else {
                  var downloadLink = window.document.createElement('a');
                  var contentTypeHeader = request.getResponseHeader("Content-Type");
                  downloadLink.href = window.URL.createObjectURL(new Blob([blob], { type: contentTypeHeader }));
                  var contentDispositionHeader = request.getResponseHeader("Content-Disposition");
                  var ma = contentDispositionHeader.match(/filename="(\d+.json)"/);
                  if (ma != null) fileName = ma[1];
                  downloadLink.download = fileName;
                  document.body.appendChild(downloadLink);
                  downloadLink.click();
                  document.body.removeChild(downloadLink);
               }
            }
          };
          request.send("optype=download_conf&token="+token+"&id="+id+'&csrfmiddlewaretoken='+'{{ csrf_token }}');
      }

      function add_or_update_bot() {
          var botName = document.getElementById("botName").value;
          var botID = document.getElementById("botID").value;
          var ownerID = document.getElementById("ownerID").value;
          var accessToken = document.getElementById("accessToken").value;
          var tulingToken = document.getElementById("tulingToken").value;
          var api_post_url = document.getElementById("api_post_url").value;
          var autoFriend = document.getElementById("autoFriend").checked;
          var autoInvite = document.getElementById("autoInvite").checked;
          $.ajax({
              type: 'POST',
              url: '',
              async: false,
              data: {
                  "optype": "add_or_update_bot",
                  "botName": botName,
                  "botID": botID,
                  "ownerID": ownerID,
                  "accessToken": accessToken,
                  "tulingToken": tulingToken,
                  "api_post_url": api_post_url,
                  "autoFriend": autoFriend,
                  "autoInvite": autoInvite,
                  'csrfmiddlewaretoken': '{{ csrf_token }}'
              },
              success: function (data) {
                  if (data.response != "success") {
                      if (data.response == "error") {
                          alert(data.msg);
                      } else {
                          alert(data.response);
                          console.log(data);
                      }
                  } else {
                      prompt(data.msg, data.token);
                      location.reload();
                  }
              },
          });
      }
  </script>
{% endblock %}

</body>
</html>